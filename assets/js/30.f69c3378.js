(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{382:function(e,t,o){"use strict";o.r(t);var v=o(9),l=Object(v.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"黑客入侵检查"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#黑客入侵检查"}},[e._v("#")]),e._v(" 黑客入侵检查")]),e._v(" "),t("hr"),e._v(" "),t("h2",{attrs:{id:"思路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#思路"}},[e._v("#")]),e._v(" 思路")]),e._v(" "),t("ul",[t("li",[e._v("扫描木马工具："),t("code",[e._v("clamAV")]),e._v(" "),t("ul",[t("li",[e._v("官网："),t("a",{attrs:{href:"http://pkgs.repoforge.org/clamav/",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://pkgs.repoforge.org/clamav/"),t("OutboundLink")],1)])])]),e._v(" "),t("li",[e._v("CentOS 安装："),t("code",[e._v("yum install -y clamav*")])]),e._v(" "),t("li",[e._v("启动 clamAV 服务："),t("code",[e._v("service clamd restart")])]),e._v(" "),t("li",[e._v("更新病毒库："),t("code",[e._v("freshclam")])]),e._v(" "),t("li",[e._v("扫描方法：\n"),t("ul",[t("li",[e._v("扫描 /etc 目录，并把扫描结果放在 /root 目录下："),t("code",[e._v("clamscan -r /etc --max-dir-recursion=5 -l /root/etcclamav.log")])]),e._v(" "),t("li",[e._v("扫描 /bin 目录，并把扫描结果放在 /root 目录下："),t("code",[e._v("clamscan -r /bin --max-dir-recursion=5 -l /root/binclamav.log")])]),e._v(" "),t("li",[e._v("扫描 /usr 目录，并把扫描结果放在 /root 目录下："),t("code",[e._v("clamscan -r /usr --max-dir-recursion=5 -l /root/usrclamav.log")])])])]),e._v(" "),t("li",[e._v("如果日志有类似内容，表示有木马病毒：\n"),t("ul",[t("li",[t("code",[e._v("/usr/bin/.sshd: Linux.Trojan.Agent FOUND")])]),e._v(" "),t("li",[t("code",[e._v("/usr/sbin/ss: Linux.Trojan.Agent FOUND")])]),e._v(" "),t("li",[t("code",[e._v("/usr/sbin/lsof: Linux.Trojan.Agent FOUND")])])])]),e._v(" "),t("li",[e._v("看下当前有多少登录者："),t("code",[e._v("who")])]),e._v(" "),t("li",[e._v("看下最近有哪些登录者："),t("code",[e._v("last")])]),e._v(" "),t("li",[e._v("查看最近尝试登录的账号信息："),t("code",[e._v('grep "sshd" /var/log/secure')]),e._v(" "),t("ul",[t("li",[e._v("很多这种信息就表示有人在不断地尝试用 root 登录："),t("code",[e._v("Failed password for root from 222.186.56.168 port 4080 ssh2")])])])]),e._v(" "),t("li",[e._v("查看最近登录成功的账号信息："),t("code",[e._v('grep "Accepted" /var/log/secure')]),e._v("，可以看到：pop3, ssh, telnet, ftp 类型")]),e._v(" "),t("li",[e._v("看下查看系统资源占用有无异常："),t("code",[e._v("top")])]),e._v(" "),t("li",[e._v("看下所有进程："),t("code",[e._v("ps aux")])]),e._v(" "),t("li",[e._v("查看当前系统登录者有哪些，及其登录记录："),t("code",[e._v("last | more")])]),e._v(" "),t("li",[e._v("把最近执行的所有命令输出到一个文件，然后下载下来细细研究："),t("code",[e._v("history >> /opt/test.txt")])]),e._v(" "),t("li",[e._v("查看当前系统所有用户有哪些："),t("code",[e._v("cat /etc/passwd |awk -F \\: '{print $1}'")]),e._v(" "),t("ul",[t("li",[e._v("更多详细可以用："),t("code",[e._v("cat /etc/passwd")])])])]),e._v(" "),t("li",[e._v("查看开放的端口，比如常用的80,22,8009，后面的箭头表示端口对应占用的程序："),t("code",[e._v("netstat -lnp")])]),e._v(" "),t("li",[e._v("检查某个端口的具体信息："),t("code",[e._v("lsof -i :18954")])]),e._v(" "),t("li",[e._v("检查启动项："),t("code",[e._v("chkconfig")])]),e._v(" "),t("li",[e._v("检查定时器（重要）："),t("code",[e._v("cat /etc/crontab")])]),e._v(" "),t("li",[e._v("检查定时器（重要）："),t("code",[e._v("crontab -l")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("vim /var/spool/cron/crontabs/root")])]),e._v(" "),t("li",[t("code",[e._v("vim /var/spool/cron/root")])])])]),e._v(" "),t("li",[e._v("检查其他系统重要文件：\n"),t("ul",[t("li",[t("code",[e._v("cat /etc/rc.local")])]),e._v(" "),t("li",[t("code",[e._v("cd /etc/init.d;ll")])])])]),e._v(" "),t("li",[e._v("检查文件：\n"),t("ul",[t("li",[t("code",[e._v("find / -uid 0 –perm -4000 –print")])]),e._v(" "),t("li",[t("code",[e._v("find / -size +10000k –print")])]),e._v(" "),t("li",[t("code",[e._v('find / -name "…" –print')])]),e._v(" "),t("li",[t("code",[e._v('find / -name ".. " –print')])]),e._v(" "),t("li",[t("code",[e._v('find / -name ". " –print')])]),e._v(" "),t("li",[t("code",[e._v('find / -name " " –print')])])])]),e._v(" "),t("li",[e._v("下载 iftop 分析流量，查看是否被黑客当做肉鸡使用")]),e._v(" "),t("li",[e._v("安装 iftop\n"),t("ul",[t("li",[e._v("官网："),t("a",{attrs:{href:"http://www.ex-parrot.com/~pdw/iftop/",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://www.ex-parrot.com/~pdw/iftop/"),t("OutboundLink")],1)]),e._v(" "),t("li",[e._v("使用文章："),t("a",{attrs:{href:"https://linux.cn/article-1843-1.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://linux.cn/article-1843-1.html"),t("OutboundLink")],1)]),e._v(" "),t("li",[e._v("没有安装第三方源的情况：\n"),t("ul",[t("li",[e._v("安装依赖包："),t("code",[e._v("yum install -y flex byacc libpcap ncurses ncurses-devel libpcap-devel")])]),e._v(" "),t("li",[e._v("下载源码包："),t("code",[e._v("wget http://www.ex-parrot.com/pdw/iftop/download/iftop-0.17.tar.gz")])]),e._v(" "),t("li",[e._v("解压："),t("code",[e._v("tar zxf iftop-0.17.tar.gz")])]),e._v(" "),t("li",[e._v("进入解压目录："),t("code",[e._v("cd iftop-0.17/")])]),e._v(" "),t("li",[e._v("编译："),t("code",[e._v("./configure")])]),e._v(" "),t("li",[e._v("安装："),t("code",[e._v("make && make install")])])])]),e._v(" "),t("li",[e._v("有第三方源的情况（eg：EPEL）：\n"),t("ul",[t("li",[t("code",[e._v("yum install -y iftop")])])])])])]),e._v(" "),t("li",[e._v("运行："),t("code",[e._v("iftop")]),e._v(" "),t("ul",[t("li",[e._v("显示端口与 IP 信息："),t("code",[e._v("iftop -nP")])])])])]),e._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[e._v("中间部分：外部连接列表，即记录了哪些ip正在和本机的网络连接\n\n右边部分：实时参数分别是该访问 ip 连接到本机 2 秒，10 秒和 40 秒的平均流量\n\n=> 代表发送数据，<= 代表接收数据\n\n底部会显示一些全局的统计数据，peek 是指峰值情况，cumm 是从 iftop 运行至今的累计情况，而 rates 表示最近 2 秒、10 秒、40 秒内总共接收或者发送的平均网络流量。\n\nTX:（发送流量）  cumm:   143MB   peak:   10.5Mb    rates:   1.03Mb  1.54Mb  2.10Mb\nRX:（接收流量）          12.7GB          228Mb              189Mb   191Mb   183Mb\nTOTAL:（总的流量）       12.9GB          229Mb              190Mb   193Mb   185MbW\n\n")])])]),t("ul",[t("li",[e._v("禁用 root 账号登录："),t("code",[e._v("vim /etc/ssh/sshd_config")]),e._v(" "),t("ul",[t("li",[e._v("把 PermitRootLogin 属性 yes 改为 no")])])]),e._v(" "),t("li",[e._v("如果安全度要更高，可以考虑禁用口令登录，采用私钥/公钥方式："),t("code",[e._v("vim /etc/ssh/sshd_config")]),e._v(" "),t("ul",[t("li",[e._v("设置属性：PasswordAuthentication 为 no")])])]),e._v(" "),t("li",[e._v("如果还要限制指定 IP 登录，可以考虑编辑：hosts.allow 和 hosts.deny 两个文件")]),e._v(" "),t("li",[e._v("重要系统软件更新（更新之前最好先做好系统镜像或是快照，以防万一）：\n"),t("ul",[t("li",[e._v("yum update kernel")]),e._v(" "),t("li",[e._v("yum update kernel-devel")]),e._v(" "),t("li",[e._v("yum update kernel-firmware")]),e._v(" "),t("li",[e._v("yum update kernel-headers")]),e._v(" "),t("li",[e._v("yum update openssh")]),e._v(" "),t("li",[e._v("yum update openssh-clients")]),e._v(" "),t("li",[e._v("yum update openssh-server")])])])]),e._v(" "),t("h2",{attrs:{id:"实战"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实战"}},[e._v("#")]),e._v(" 实战")]),e._v(" "),t("h4",{attrs:{id:"挖矿程序"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#挖矿程序"}},[e._v("#")]),e._v(" 挖矿程序")]),e._v(" "),t("ul",[t("li",[e._v("先查看调度任务是否有新增内容\n"),t("ul",[t("li",[t("code",[e._v("vim /var/spool/cron/root")])]),e._v(" "),t("li",[t("code",[e._v("vim /var/spool/cron/crontabs/root")])])])]),e._v(" "),t("li",[e._v("如果有，先停止定时任务："),t("code",[e._v("systemctl stop crond")])]),e._v(" "),t("li",[e._v("如果对方有去 wget curl 指定网站，则先在 hosts 里面映射为 127.0.0.1，比如："),t("code",[e._v("127.0.0.1 prax0zma.ru")]),e._v(" "),t("ul",[t("li",[e._v("查看当前最占用 CPU 的进程 PID，加入发现是 22935，则："),t("code",[e._v("cd /proc/22935 && ll")]),e._v("，发现程序目录是："),t("code",[e._v("/root/.tmp00/bash64")])]),e._v(" "),t("li",[e._v("我们就把该程序去掉执行任务的权限："),t("code",[e._v("chmod -R -x /root/.tmp00/")]),e._v("，然后再 kill 掉该程序")])])]),e._v(" "),t("li",[e._v("打开别人的脚本，看下是如何书写的，发现有写入几个目录，这里进行删除：")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("rm -rf /tmp/.ha /boot/.b /boot/.0 /root/.tmp00\n")])])]),t("ul",[t("li",[e._v("最后检查下是否有免密内容被修改："),t("code",[e._v("cd ~/.ssh/ && cat authorized_keys")])])]),e._v(" "),t("h2",{attrs:{id:"资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#资料"}},[e._v("#")]),e._v(" 资料")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://www.jianshu.com/p/97b9dc47b88c",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://www.jianshu.com/p/97b9dc47b88c"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://monklof.com/post/10/",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://monklof.com/post/10/"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://yafeilee.me/blogs/54be6e876c69341430050000",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://yafeilee.me/blogs/54be6e876c69341430050000"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://coolnull.com/4174.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://coolnull.com/4174.html"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://www.oicqzone.com/pc/2014110420118.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://www.oicqzone.com/pc/2014110420118.html"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=l.exports}}]);