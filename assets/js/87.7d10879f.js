(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{435:function(t,e,a){"use strict";a.r(e);var s=a(9),n=Object(s.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"nginx-keepalived-高可用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-keepalived-高可用"}},[t._v("#")]),t._v(" Nginx + Keepalived 高可用")]),t._v(" "),e("h2",{attrs:{id:"说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#说明"}},[t._v("#")]),t._v(" 说明")]),t._v(" "),e("ul",[e("li",[t._v("高可用 HA（High Availability），简单讲就是：我某个应用挂了，自动有另外应用起来接着扛着，致使整个服务对外来看是没有中断过的。这里的重点就是不中断，致使公司整个业务能不断进行中，把影响减到最小，赚得更多。")]),t._v(" "),e("li",[t._v("因为要不中断，所以我们就需要用到了 Keepalived。Keepalived 一般不会单独使用，基本都是跟负载均衡软件（LVS、HAProxy、Nginx）一起工作来达到集群的高可用效果。")]),t._v(" "),e("li",[t._v("Keepalived 有双主、主备方案")]),t._v(" "),e("li",[t._v("常用词：\n"),e("ul",[e("li",[t._v("心跳：Master 会主动给 Backup 发送心跳检测包以及对外的网络功能，而 Backup 负责接收 Master 的心跳检测包，随时准备接管主机。为什么叫心跳不知道，但是挺形象的，心跳同步。")]),t._v(" "),e("li",[t._v("选举：Keepalived 配置的时候可以指定各台主机优先级，Master 挂了，各台 Backup 要选举出一个新的 Master。")])])]),t._v(" "),e("li",[t._v("Keepalived\n"),e("ul",[e("li",[t._v("官网："),e("a",{attrs:{href:"http://www.keepalived.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://www.keepalived.org/"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v("官网下载："),e("a",{attrs:{href:"http://www.keepalived.org/download.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://www.keepalived.org/download.html"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v("官网文档："),e("a",{attrs:{href:"http://www.keepalived.org/documentation.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://www.keepalived.org/documentation.html"),e("OutboundLink")],1)])])])]),t._v(" "),e("h2",{attrs:{id:"搭建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#搭建"}},[t._v("#")]),t._v(" 搭建")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("软件版本：")]),t._v(" "),e("ul",[e("li",[t._v("Nginx："),e("strong",[t._v("1.8.1")])]),t._v(" "),e("li",[t._v("Keepalived："),e("strong",[t._v("1.2.20")])]),t._v(" "),e("li",[t._v("JDK："),e("strong",[t._v("8u72")])]),t._v(" "),e("li",[t._v("Tomcat："),e("strong",[t._v("8.0.32")])])])]),t._v(" "),e("li",[e("p",[t._v("部署环境（下文中以第几台来代表这些主机）：")]),t._v(" "),e("ul",[e("li",[t._v("虚拟 IP（VIP）：192.168.1.50")]),t._v(" "),e("li",[t._v("第一台主机：Nginx 1 + Keepalived 1 == 192.168.1.120（Master）")]),t._v(" "),e("li",[t._v("第二台主机：Nginx 2 + Keepalived 2 == 192.168.1.121（Backup）")]),t._v(" "),e("li",[t._v("第三台主机：Tomcat 1 == 192.168.1.122（Web 1）")]),t._v(" "),e("li",[t._v("第四台主机：Tomcat 2 == 192.168.1.123（Web 2）")])])]),t._v(" "),e("li",[e("p",[t._v("所有机子进行时间校准："),e("RouterLink",{attrs:{to:"/linux/soft/Nginx&Tomcat/NTP.html"}},[t._v("NTP（Network Time Protocol）介绍")])],1)]),t._v(" "),e("li",[e("p",[t._v("第三、第四台主机部署：")]),t._v(" "),e("ul",[e("li",[t._v("JDK 的安装："),e("RouterLink",{attrs:{to:"/linux/soft/Nginx&Tomcat/JDK-Install.html"}},[t._v("JDK 安装")])],1),t._v(" "),e("li",[t._v("Tomcat 的安装："),e("RouterLink",{attrs:{to:"/linux/soft/Nginx&Tomcat/Tomcat-Install-And-Settings.html"}},[t._v("Tomcat 安装和配置、优化")])],1)])]),t._v(" "),e("li",[e("p",[t._v("第一、二台主机部署（两台部署内容一样）：")]),t._v(" "),e("ul",[e("li",[t._v("Nginx 的安装："),e("RouterLink",{attrs:{to:"/linux/soft/Nginx&Tomcat/Nginx-Install-And-Settings.html"}},[t._v("Nginx 安装和配置")])],1),t._v(" "),e("li",[t._v("添加虚拟 IP：\n"),e("ul",[e("li",[t._v("复制一个网卡信息："),e("code",[t._v("sudo cp /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth0:0")])]),t._v(" "),e("li",[t._v("编辑配置文件："),e("code",[t._v("sudo vim /etc/sysconfig/network-scripts/ifcfg-eth0:0")])]),t._v(" "),e("li",[t._v("修改内容为如下信息：")])]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[t._v('DEVICE=eth0:0    >>> 这个需要修改\nTYPE=Ethernet\nUUID=8ddbb256-caab-4ddf-8e9a-6527b4ac5a26\nONBOOT=yes \nNM_CONTROLLED=yes\nBOOTPROTO=none\nIPADDR=192.168.1.50    >>> 这个需要修改\nPREFIX=24  \nGATEWAY=192.168.1.1\nDNS1=101.226.4.6\nDEFROUTE=yes\nIPV4_FAILURE_FATAL=yes\nIPV6INIT=no\nNAME="System eth0:0"    >>> 这个需要修改\nHWADDR=00:0c:29:f4:17:db\nLAST_CONNECT=1460213205\n')])])]),e("ul",[e("li",[t._v("重启网卡服务："),e("code",[t._v("service network restart")])]),t._v(" "),e("li",[t._v("如果你要绑定更多虚拟 IP，则多复制几个网卡配置出来，命名如下：ifcfg-eth0:0，ifcfg-eth0:1，ifcfg-eth0:2 ......")])])]),t._v(" "),e("li",[t._v("Keepalived 开始安装\n"),e("ul",[e("li",[t._v("安装依赖："),e("code",[t._v("sudo yum install -y gcc openssl-devel popt-devel")])]),t._v(" "),e("li",[t._v("解压包："),e("code",[t._v("cd /opt/setups/ ; tar zxvf keepalived-1.2.20.tar.gz")])]),t._v(" "),e("li",[t._v("编译："),e("code",[t._v("cd /opt/setups/keepalived-1.2.20 ; ./configure --prefix=/usr/program/keepalived")])]),t._v(" "),e("li",[t._v("编译安装："),e("code",[t._v("make && make install")])])])]),t._v(" "),e("li",[t._v("Keepalived 设置服务和随机启动\n"),e("ul",[e("li",[t._v("复制配置文件到启动脚本目录："),e("code",[t._v("cp /usr/program/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/keepalived")])]),t._v(" "),e("li",[t._v("增加权限："),e("code",[t._v("chmod +x /etc/init.d/keepalived")])]),t._v(" "),e("li",[t._v("编辑配置文件："),e("code",[t._v("vim /etc/init.d/keepalived")])])]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[t._v("把 15 行的：. /etc/sysconfig/keepalived，改为：\n. /usr/program/keepalived/etc/sysconfig/keepalived（注意：前面有一个点和空格需要注意）\n")])])]),e("ul",[e("li",[t._v("添加环境变量："),e("code",[t._v("vim /etc/profile")])])]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Keepalived 配置")]),t._v("\nKEEPALIVED_HOME=/usr/program/keepalived\nPATH=$PATH:$KEEPALIVED_HOME/sbin\nexport KEEPALIVED_HOME\nexport PATH\n")])])]),e("ul",[e("li",[t._v("刷新环境变量："),e("code",[t._v("source /etc/profile")])]),t._v(" "),e("li",[t._v("检测环境变量："),e("code",[t._v("keepalived -v")])]),t._v(" "),e("li",[e("code",[t._v("ln -s /usr/program/keepalived/sbin/keepalived /usr/sbin/")])]),t._v(" "),e("li",[e("code",[t._v("vim /usr/program/keepalived/etc/sysconfig/keepalived")])])]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[t._v('把 14 行的：KEEPALIVED_OPTIONS="-D"，改为：\nKEEPALIVED_OPTIONS="-D -f /usr/program/keepalived/etc/keepalived/keepalived.conf"\n')])])]),e("ul",[e("li",[t._v("加入随机启动："),e("code",[t._v("chkconfig keepalived on")])])])])])]),t._v(" "),e("li",[e("p",[t._v("第一、二台主机配置（两台在 Keepalived 配置上稍微有不一样）：")]),t._v(" "),e("ul",[e("li",[t._v("健康监测脚本（我个人放在：/opt/bash 目录下）："),e("a",{attrs:{href:"Keepalived-Settings/nginx_check.sh"}},[t._v("nginx_check.sh")])]),t._v(" "),e("li",[t._v("健康监测脚本添加执行权限："),e("code",[t._v("chmod 755 /opt/bash/nginx_check.sh")])]),t._v(" "),e("li",[t._v("运行监测脚本，看下是否有问题："),e("code",[t._v("sh /opt/bash/nginx_check.sh")]),t._v("，如果没有报错，则表示改脚本没有问题\n"),e("ul",[e("li",[t._v("这个脚本很重要，如果脚本没法用，在启用 Keepalived 的时候可能会报："),e("code",[t._v("Keepalived_vrrp[5684]: pid 5959 exited with status 1")])])])]),t._v(" "),e("li",[t._v("nginx 配置（两台一样配置）：")])]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_processes")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("events")])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_connections")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v("       mime.types")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v("  application/octet-stream")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sendfile")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("keepalive_timeout")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("65")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# （重点）")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" tomcatCluster")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 192.168.1.122:8080 weight=1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 192.168.1.123:8080 weight=1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# （重点）")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("  192.168.1.50")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v("   http://tomcatCluster")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v("  index.html index.htm")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("ul",[e("li",[t._v("Keepalived 配置文件编辑（第一、二台配置稍微不同，不同点具体看下面重点说明）\n"),e("ul",[e("li",[t._v("编辑："),e("code",[t._v("vim /usr/program/keepalived/etc/keepalived/keepalived.conf")])])])])]),t._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[t._v("! "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Configuration")]),t._v(" File for keepalived\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 全局配置")]),t._v("\nglobal_defs")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 邮箱通知配置，keepalived 在发生切换时需要发送 email 到的对象，一行一个")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("notification_email")])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#acassen@firewall.loc")]),t._v("\n\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#failover@firewall.loc")]),t._v("\n\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#sysadmin@firewall.loc")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定发件人")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#notification_email_from Alexandre.Cassen@firewall.loc")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定smtp服务器地址")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#smtp_server 192.168.200.1")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定smtp连接超时时间，单位秒")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#smtp_connect_timeout 30")]),t._v("\n\t\n\trouter_id LVS_DEVEL\n\tvrrp_skip_check_adv_addr\n\tvrrp_strict\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# （重点）脚本监控实现")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("vrrp_script")]),t._v(" check_nginx")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 运行脚本")]),t._v('\n\tscript "/opt/bash/nginx_check.sh"\n\t'),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 时间间隔，2秒")]),t._v("\n\tinterval 2\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 权重")]),t._v("\n\tweight 2\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("vrrp_instance")]),t._v(" VI_1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# （重点）Backup 机子这里是设置为：BACKUP")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("state")]),t._v(" MASTER\n\tinterface eth0\n\tvirtual_router_id "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("51")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# （重点）Backup 机子要小于当前 Master 设置的 100，建议设置为 99")]),t._v("\n\tpriority "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Master 与 Backup 负载均衡器之间同步检查的时间间隔，单位是秒")]),t._v("\n\tadvert_int "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\tauthentication")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tauth_type PASS\n\t\tauth_pass 1111\n\t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# （重点）配置虚拟 IP 地址，如果有多个则一行一个")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual_ipaddress")])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t192.168.1.50\n\t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# （重点）脚本监控调用")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("track_script")])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tcheck_nginx\n\t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"启动各自服务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动各自服务"}},[t._v("#")]),t._v(" 启动各自服务")]),t._v(" "),e("ul",[e("li",[t._v("四台机子都停掉防火墙："),e("code",[t._v("service iptables stop")])]),t._v(" "),e("li",[t._v("先启动两台 Tomcat："),e("code",[t._v("sh /usr/program/tomcat8/bin/startup.sh ; tail -200f /usr/program/tomcat8/logs/catalina.out")]),t._v(" "),e("ul",[e("li",[t._v("检查两台 Tomcat 是否可以单独访问，最好给首页加上不同标识，好方便等下确认是否有负载\n"),e("ul",[e("li",[e("code",[t._v("http://192.168.1.122:8080")])]),t._v(" "),e("li",[e("code",[t._v("http://192.168.1.123:8080")])])])])])]),t._v(" "),e("li",[t._v("启动两台 Nginx 服务："),e("code",[t._v("/usr/local/nginx/sbin/nginx")])]),t._v(" "),e("li",[t._v("启动两台 Keepalived 服务："),e("code",[t._v("service keepalived start")])]),t._v(" "),e("li",[t._v("查看 Master 和 Backup 两台主机的对应日志："),e("code",[t._v("tail -f /var/log/messages")])])]),t._v(" "),e("h3",{attrs:{id:"高可用测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#高可用测试"}},[t._v("#")]),t._v(" 高可用测试")]),t._v(" "),e("ul",[e("li",[t._v("模拟 Keepalived 挂掉\n"),e("ul",[e("li",[t._v("关闭 Master 主机的 Keepalived，查看 Master 和 Backup 两台主机的对应日志："),e("code",[t._v("tail -f /var/log/messages")]),t._v(" "),e("ul",[e("li",[t._v("关闭服务："),e("code",[t._v("service keepalived stop")])]),t._v(" "),e("li",[t._v("如果第二台机接管了，则表示成功")])])]),t._v(" "),e("li",[t._v("重新开启 Master 主机的 Keepalived，查看 Master 和 Backup 两台主机的对应日志："),e("code",[t._v("tail -f /var/log/messages")]),t._v(" "),e("ul",[e("li",[t._v("重启服务："),e("code",[t._v("service keepalived restart")])]),t._v(" "),e("li",[t._v("如果第一台机重新接管了，则表示成功")])])])])]),t._v(" "),e("li",[t._v("模拟 Nginx 挂掉\n"),e("ul",[e("li",[t._v("关闭 Master 主机的 Nginx，查看 Master 和 Backup 两台主机的对应日志："),e("code",[t._v("tail -f /var/log/messages")]),t._v(" "),e("ul",[e("li",[t._v("关闭服务："),e("code",[t._v("/usr/local/nginx/sbin/nginx -s stop")])]),t._v(" "),e("li",[t._v("如果第二台机接管了，则表示成功")])])]),t._v(" "),e("li",[t._v("重新开启 Master 主机的 Nginx，查看 Master 和 Backup 两台主机的对应日志："),e("code",[t._v("tail -f /var/log/messages")]),t._v(" "),e("ul",[e("li",[t._v("重启 Nginx 服务："),e("code",[t._v("/usr/local/nginx/sbin/nginx -s reload")])]),t._v(" "),e("li",[t._v("重启 Keepalived 服务："),e("code",[t._v("service keepalived restart")])]),t._v(" "),e("li",[t._v("如果第一台机重新接管了，则表示成功")])])])])]),t._v(" "),e("li",[t._v("可以优化的地方，改为双主热备，监控脚本上带有自启动相关细节，后续再进行。")]),t._v(" "),e("li",[t._v("日志中常用的几句话解释：\n"),e("ul",[e("li",[e("code",[t._v("Entering to MASTER STATE")]),t._v("，变成 Master 状态\n"),e("ul",[e("li",[e("code",[t._v("Netlink reflector reports IP 192.168.1.50 added")]),t._v("，一般变为 Master 状态，都要重新加入虚拟 IP，一般叫法叫做：虚拟 IP 重新漂移到 Master 机子上")])])]),t._v(" "),e("li",[e("code",[t._v("Entering BACKUP STATE")]),t._v("，变成 Backup 状态\n"),e("ul",[e("li",[e("code",[t._v("Netlink reflector reports IP 192.168.1.50 removed")]),t._v("，一般变为 Backup 状态，都要移出虚拟 IP，一般叫法叫做：虚拟 IP 重新漂移到 Master 机子上")])])]),t._v(" "),e("li",[e("code",[t._v("VRRP_Script(check_nginx) succeeded")]),t._v("，监控脚本执行成功")])])])]),t._v(" "),e("h2",{attrs:{id:"资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#资料"}},[t._v("#")]),t._v(" 资料")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"http://xutaibao.blog.51cto.com/7482722/1669123",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://xutaibao.blog.51cto.com/7482722/1669123"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://m.oschina.net/blog/301710",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://m.oschina.net/blog/301710"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"http://blog.csdn.net/u010028869/article/details/50612571",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://blog.csdn.net/u010028869/article/details/50612571"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"http://blog.csdn.net/wanglei_storage/article/details/51175418",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://blog.csdn.net/wanglei_storage/article/details/51175418"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=n.exports}}]);