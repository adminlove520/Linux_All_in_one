<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx + Keepalived 高可用 | Linux_All_in_one</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/Linux_All_in_one/favicon.ico">
    <meta name="description" content="Linux 运维、软件运维、Docker 教程、网络安全">
    
    <link rel="preload" href="/Linux_All_in_one/assets/css/0.styles.407428ab.css" as="style"><link rel="preload" href="/Linux_All_in_one/assets/js/app.4a61619a.js" as="script"><link rel="preload" href="/Linux_All_in_one/assets/js/2.ee3c5eb7.js" as="script"><link rel="preload" href="/Linux_All_in_one/assets/js/1.bc260717.js" as="script"><link rel="preload" href="/Linux_All_in_one/assets/js/87.7d10879f.js" as="script"><link rel="preload" href="/Linux_All_in_one/assets/js/21.f8578145.js" as="script"><link rel="prefetch" href="/Linux_All_in_one/assets/js/100.5e0212b4.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/101.280ba6c4.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/102.fcbe69ef.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/103.59b3bf86.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/104.628bb6be.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/105.f6a0a62b.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/106.53648c35.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/107.093c4fab.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/108.f8895b2f.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/109.878b5e6d.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/110.e7dbd5ce.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/12.4bdd7f50.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/13.4850c8c8.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/14.66e24ed5.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/15.41d57e79.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/16.96600c16.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/17.1cd68a21.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/18.f54ebd77.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/19.36d25975.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/20.0120ca8c.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/22.9efa850b.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/23.d7f5441c.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/24.1cabd94c.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/25.2cb5712a.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/26.440ab754.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/27.94e60af2.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/28.f1611369.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/29.730dead3.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/3.accc0318.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/30.f69c3378.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/31.be2478fc.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/32.9465ce70.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/33.f4c85e8a.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/34.c3a0ece1.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/35.a75dd538.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/36.da0b8594.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/37.c49eb234.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/38.16f7d0e5.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/39.ba6e47f0.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/4.9736648b.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/40.664ddb58.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/41.4189f6ca.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/42.6472b832.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/43.c8d06688.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/44.e39a047e.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/45.39945860.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/46.ccbd9cdc.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/47.9bed3a75.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/48.05ecd397.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/49.4f2f2874.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/5.9a4eb5c9.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/50.d01632db.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/51.ad40e5f5.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/52.bfacfa08.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/53.9398692c.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/54.b34cb199.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/55.6735c148.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/56.575312d7.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/57.d54f0ac7.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/58.f3cc4cf5.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/59.881dba8f.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/6.a3475002.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/60.859faf8a.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/61.4efca474.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/62.578a9742.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/63.95e6ff4f.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/64.054ab297.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/65.5be33d9b.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/66.2312529e.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/67.81dd084d.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/68.a11966f3.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/69.ffbf7d57.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/7.b4d90be9.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/70.51883659.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/71.9ff55cae.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/72.d54e184f.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/73.5062fbf7.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/74.0721cccd.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/75.42dd3581.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/76.d590fa57.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/77.0e5953f3.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/78.4bb79720.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/79.48030292.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/80.d036bc22.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/81.d6524746.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/82.93460687.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/83.7c6f2e4a.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/84.83b1808d.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/85.14c12ffc.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/86.893b5c41.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/88.ef12068f.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/89.cc81e4e4.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/90.130454fc.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/91.838da398.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/92.22813cd9.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/93.2000427b.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/94.062717c8.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/95.9cc81974.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/96.0457546b.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/97.71d6bbd5.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/98.e6299973.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/99.b198a395.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/vendors~docsearch.00f0a528.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/vendors~flowchart.d07b8b19.js"><link rel="prefetch" href="/Linux_All_in_one/assets/js/vendors~notification.877bb3fc.js">
    <link rel="stylesheet" href="/Linux_All_in_one/assets/css/0.styles.407428ab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Linux_All_in_one/" class="home-link router-link-active"><img src="/Linux_All_in_one/images/dunwu-logo-100.png" alt="Linux_All_in_one" class="logo"> <span class="site-name can-hide">Linux_All_in_one</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Linux_All_in_one/linux/cli/" class="nav-link">
  💻 Linux 命令
</a></div><div class="nav-item"><a href="/Linux_All_in_one/linux/ops/" class="nav-link">
  ⚙️ Linux 运维
</a></div><div class="nav-item"><a href="/Linux_All_in_one/linux/soft/" class="nav-link router-link-active">
  📦 Linux 软件运维
</a></div><div class="nav-item"><a href="/Linux_All_in_one/docker/" class="nav-link">
  🐳 Docker 教程
</a></div><div class="nav-item"><a href="/Linux_All_in_one/Cybersecurity/" class="nav-link">
  🔒 Linux与网络安全
</a></div> <a href="https://github.com/adminlove520/Linux_All_in_one" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Linux_All_in_one/linux/cli/" class="nav-link">
  💻 Linux 命令
</a></div><div class="nav-item"><a href="/Linux_All_in_one/linux/ops/" class="nav-link">
  ⚙️ Linux 运维
</a></div><div class="nav-item"><a href="/Linux_All_in_one/linux/soft/" class="nav-link router-link-active">
  📦 Linux 软件运维
</a></div><div class="nav-item"><a href="/Linux_All_in_one/docker/" class="nav-link">
  🐳 Docker 教程
</a></div><div class="nav-item"><a href="/Linux_All_in_one/Cybersecurity/" class="nav-link">
  🔒 Linux与网络安全
</a></div> <a href="https://github.com/adminlove520/Linux_All_in_one" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nginx + Keepalived 高可用</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/Nginx-Keepalived-Install-And-Settings.html#说明" class="sidebar-link">说明</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/Nginx-Keepalived-Install-And-Settings.html#搭建" class="sidebar-link">搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/Nginx-Keepalived-Install-And-Settings.html#启动各自服务" class="sidebar-link">启动各自服务</a></li><li class="sidebar-sub-header"><a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/Nginx-Keepalived-Install-And-Settings.html#高可用测试" class="sidebar-link">高可用测试</a></li></ul></li><li><a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/Nginx-Keepalived-Install-And-Settings.html#资料" class="sidebar-link">资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-keepalived-高可用"><a href="#nginx-keepalived-高可用" class="header-anchor">#</a> Nginx + Keepalived 高可用</h1> <h2 id="说明"><a href="#说明" class="header-anchor">#</a> 说明</h2> <ul><li>高可用 HA（High Availability），简单讲就是：我某个应用挂了，自动有另外应用起来接着扛着，致使整个服务对外来看是没有中断过的。这里的重点就是不中断，致使公司整个业务能不断进行中，把影响减到最小，赚得更多。</li> <li>因为要不中断，所以我们就需要用到了 Keepalived。Keepalived 一般不会单独使用，基本都是跟负载均衡软件（LVS、HAProxy、Nginx）一起工作来达到集群的高可用效果。</li> <li>Keepalived 有双主、主备方案</li> <li>常用词：
<ul><li>心跳：Master 会主动给 Backup 发送心跳检测包以及对外的网络功能，而 Backup 负责接收 Master 的心跳检测包，随时准备接管主机。为什么叫心跳不知道，但是挺形象的，心跳同步。</li> <li>选举：Keepalived 配置的时候可以指定各台主机优先级，Master 挂了，各台 Backup 要选举出一个新的 Master。</li></ul></li> <li>Keepalived
<ul><li>官网：<a href="http://www.keepalived.org/" target="_blank" rel="noopener noreferrer">http://www.keepalived.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>官网下载：<a href="http://www.keepalived.org/download.html" target="_blank" rel="noopener noreferrer">http://www.keepalived.org/download.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>官网文档：<a href="http://www.keepalived.org/documentation.html" target="_blank" rel="noopener noreferrer">http://www.keepalived.org/documentation.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul> <h2 id="搭建"><a href="#搭建" class="header-anchor">#</a> 搭建</h2> <ul><li><p>软件版本：</p> <ul><li>Nginx：<strong>1.8.1</strong></li> <li>Keepalived：<strong>1.2.20</strong></li> <li>JDK：<strong>8u72</strong></li> <li>Tomcat：<strong>8.0.32</strong></li></ul></li> <li><p>部署环境（下文中以第几台来代表这些主机）：</p> <ul><li>虚拟 IP（VIP）：192.168.1.50</li> <li>第一台主机：Nginx 1 + Keepalived 1 == 192.168.1.120（Master）</li> <li>第二台主机：Nginx 2 + Keepalived 2 == 192.168.1.121（Backup）</li> <li>第三台主机：Tomcat 1 == 192.168.1.122（Web 1）</li> <li>第四台主机：Tomcat 2 == 192.168.1.123（Web 2）</li></ul></li> <li><p>所有机子进行时间校准：<a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/NTP.html">NTP（Network Time Protocol）介绍</a></p></li> <li><p>第三、第四台主机部署：</p> <ul><li>JDK 的安装：<a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/JDK-Install.html">JDK 安装</a></li> <li>Tomcat 的安装：<a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/Tomcat-Install-And-Settings.html">Tomcat 安装和配置、优化</a></li></ul></li> <li><p>第一、二台主机部署（两台部署内容一样）：</p> <ul><li>Nginx 的安装：<a href="/Linux_All_in_one/linux/soft/Nginx&amp;Tomcat/Nginx-Install-And-Settings.html">Nginx 安装和配置</a></li> <li>添加虚拟 IP：
<ul><li>复制一个网卡信息：<code>sudo cp /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth0:0</code></li> <li>编辑配置文件：<code>sudo vim /etc/sysconfig/network-scripts/ifcfg-eth0:0</code></li> <li>修改内容为如下信息：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code>DEVICE=eth0:0    &gt;&gt;&gt; 这个需要修改
TYPE=Ethernet
UUID=8ddbb256-caab-4ddf-8e9a-6527b4ac5a26
ONBOOT=yes 
NM_CONTROLLED=yes
BOOTPROTO=none
IPADDR=192.168.1.50    &gt;&gt;&gt; 这个需要修改
PREFIX=24  
GATEWAY=192.168.1.1
DNS1=101.226.4.6
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME=&quot;System eth0:0&quot;    &gt;&gt;&gt; 这个需要修改
HWADDR=00:0c:29:f4:17:db
LAST_CONNECT=1460213205
</code></pre></div><ul><li>重启网卡服务：<code>service network restart</code></li> <li>如果你要绑定更多虚拟 IP，则多复制几个网卡配置出来，命名如下：ifcfg-eth0:0，ifcfg-eth0:1，ifcfg-eth0:2 ......</li></ul></li> <li>Keepalived 开始安装
<ul><li>安装依赖：<code>sudo yum install -y gcc openssl-devel popt-devel</code></li> <li>解压包：<code>cd /opt/setups/ ; tar zxvf keepalived-1.2.20.tar.gz</code></li> <li>编译：<code>cd /opt/setups/keepalived-1.2.20 ; ./configure --prefix=/usr/program/keepalived</code></li> <li>编译安装：<code>make &amp;&amp; make install</code></li></ul></li> <li>Keepalived 设置服务和随机启动
<ul><li>复制配置文件到启动脚本目录：<code>cp /usr/program/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/keepalived</code></li> <li>增加权限：<code>chmod +x /etc/init.d/keepalived</code></li> <li>编辑配置文件：<code>vim /etc/init.d/keepalived</code></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code>把 15 行的：. /etc/sysconfig/keepalived，改为：
. /usr/program/keepalived/etc/sysconfig/keepalived（注意：前面有一个点和空格需要注意）
</code></pre></div><ul><li>添加环境变量：<code>vim /etc/profile</code></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># Keepalived 配置</span>
KEEPALIVED_HOME=/usr/program/keepalived
PATH=$PATH:$KEEPALIVED_HOME/sbin
export KEEPALIVED_HOME
export PATH
</code></pre></div><ul><li>刷新环境变量：<code>source /etc/profile</code></li> <li>检测环境变量：<code>keepalived -v</code></li> <li><code>ln -s /usr/program/keepalived/sbin/keepalived /usr/sbin/</code></li> <li><code>vim /usr/program/keepalived/etc/sysconfig/keepalived</code></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code>把 14 行的：KEEPALIVED_OPTIONS=&quot;-D&quot;，改为：
KEEPALIVED_OPTIONS=&quot;-D -f /usr/program/keepalived/etc/keepalived/keepalived.conf&quot;
</code></pre></div><ul><li>加入随机启动：<code>chkconfig keepalived on</code></li></ul></li></ul></li> <li><p>第一、二台主机配置（两台在 Keepalived 配置上稍微有不一样）：</p> <ul><li>健康监测脚本（我个人放在：/opt/bash 目录下）：<a href="Keepalived-Settings/nginx_check.sh">nginx_check.sh</a></li> <li>健康监测脚本添加执行权限：<code>chmod 755 /opt/bash/nginx_check.sh</code></li> <li>运行监测脚本，看下是否有问题：<code>sh /opt/bash/nginx_check.sh</code>，如果没有报错，则表示改脚本没有问题
<ul><li>这个脚本很重要，如果脚本没法用，在启用 Keepalived 的时候可能会报：<code>Keepalived_vrrp[5684]: pid 5959 exited with status 1</code></li></ul></li> <li>nginx 配置（两台一样配置）：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">worker_processes</span>  <span class="token number">1</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">include</span>       mime.types</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">default_type</span>  application/octet-stream</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">sendfile</span>        <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span></span><span class="token punctuation">;</span>
    
    <span class="token comment"># （重点）</span>
    <span class="token directive"><span class="token keyword">upstream</span> tomcatCluster</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">server</span> 192.168.1.122:8080 weight=1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server</span> 192.168.1.123:8080 weight=1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment"># （重点）</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span>  192.168.1.50</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span>   http://tomcatCluster</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Keepalived 配置文件编辑（第一、二台配置稍微不同，不同点具体看下面重点说明）
<ul><li>编辑：<code>vim /usr/program/keepalived/etc/keepalived/keepalived.conf</code></li></ul></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code>! <span class="token directive"><span class="token keyword">Configuration</span> File for keepalived

<span class="token comment"># 全局配置</span>
global_defs</span> <span class="token punctuation">{</span>
	<span class="token comment"># 邮箱通知配置，keepalived 在发生切换时需要发送 email 到的对象，一行一个</span>
	<span class="token directive"><span class="token keyword">notification_email</span></span> <span class="token punctuation">{</span>
		<span class="token comment">#acassen@firewall.loc</span>
		<span class="token comment">#failover@firewall.loc</span>
		<span class="token comment">#sysadmin@firewall.loc</span>
	<span class="token punctuation">}</span>
	<span class="token comment"># 指定发件人</span>
	<span class="token comment">#notification_email_from Alexandre.Cassen@firewall.loc</span>
	<span class="token comment"># 指定smtp服务器地址</span>
	<span class="token comment">#smtp_server 192.168.200.1</span>
	<span class="token comment"># 指定smtp连接超时时间，单位秒</span>
	<span class="token comment">#smtp_connect_timeout 30</span>
	
	router_id LVS_DEVEL
	vrrp_skip_check_adv_addr
	vrrp_strict
<span class="token punctuation">}</span>

<span class="token comment"># （重点）脚本监控实现</span>
<span class="token directive"><span class="token keyword">vrrp_script</span> check_nginx</span> <span class="token punctuation">{</span>
	<span class="token comment"># 运行脚本</span>
	script &quot;/opt/bash/nginx_check.sh&quot;
	<span class="token comment"># 时间间隔，2秒</span>
	interval 2
	<span class="token comment"># 权重</span>
	weight 2
<span class="token punctuation">}</span>


<span class="token directive"><span class="token keyword">vrrp_instance</span> VI_1</span> <span class="token punctuation">{</span>
	<span class="token comment"># （重点）Backup 机子这里是设置为：BACKUP</span>
	<span class="token directive"><span class="token keyword">state</span> MASTER
	interface eth0
	virtual_router_id <span class="token number">51</span>
	<span class="token comment"># （重点）Backup 机子要小于当前 Master 设置的 100，建议设置为 99</span>
	priority <span class="token number">100</span>
	<span class="token comment"># Master 与 Backup 负载均衡器之间同步检查的时间间隔，单位是秒</span>
	advert_int <span class="token number">1</span>
	authentication</span> <span class="token punctuation">{</span>
		auth_type PASS
		auth_pass 1111
	<span class="token punctuation">}</span>
	
	<span class="token comment"># （重点）配置虚拟 IP 地址，如果有多个则一行一个</span>
	<span class="token directive"><span class="token keyword">virtual_ipaddress</span></span> <span class="token punctuation">{</span>
		192.168.1.50
	<span class="token punctuation">}</span>
	
	<span class="token comment"># （重点）脚本监控调用</span>
	<span class="token directive"><span class="token keyword">track_script</span></span> <span class="token punctuation">{</span>
		check_nginx
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="启动各自服务"><a href="#启动各自服务" class="header-anchor">#</a> 启动各自服务</h3> <ul><li>四台机子都停掉防火墙：<code>service iptables stop</code></li> <li>先启动两台 Tomcat：<code>sh /usr/program/tomcat8/bin/startup.sh ; tail -200f /usr/program/tomcat8/logs/catalina.out</code> <ul><li>检查两台 Tomcat 是否可以单独访问，最好给首页加上不同标识，好方便等下确认是否有负载
<ul><li><code>http://192.168.1.122:8080</code></li> <li><code>http://192.168.1.123:8080</code></li></ul></li></ul></li> <li>启动两台 Nginx 服务：<code>/usr/local/nginx/sbin/nginx</code></li> <li>启动两台 Keepalived 服务：<code>service keepalived start</code></li> <li>查看 Master 和 Backup 两台主机的对应日志：<code>tail -f /var/log/messages</code></li></ul> <h3 id="高可用测试"><a href="#高可用测试" class="header-anchor">#</a> 高可用测试</h3> <ul><li>模拟 Keepalived 挂掉
<ul><li>关闭 Master 主机的 Keepalived，查看 Master 和 Backup 两台主机的对应日志：<code>tail -f /var/log/messages</code> <ul><li>关闭服务：<code>service keepalived stop</code></li> <li>如果第二台机接管了，则表示成功</li></ul></li> <li>重新开启 Master 主机的 Keepalived，查看 Master 和 Backup 两台主机的对应日志：<code>tail -f /var/log/messages</code> <ul><li>重启服务：<code>service keepalived restart</code></li> <li>如果第一台机重新接管了，则表示成功</li></ul></li></ul></li> <li>模拟 Nginx 挂掉
<ul><li>关闭 Master 主机的 Nginx，查看 Master 和 Backup 两台主机的对应日志：<code>tail -f /var/log/messages</code> <ul><li>关闭服务：<code>/usr/local/nginx/sbin/nginx -s stop</code></li> <li>如果第二台机接管了，则表示成功</li></ul></li> <li>重新开启 Master 主机的 Nginx，查看 Master 和 Backup 两台主机的对应日志：<code>tail -f /var/log/messages</code> <ul><li>重启 Nginx 服务：<code>/usr/local/nginx/sbin/nginx -s reload</code></li> <li>重启 Keepalived 服务：<code>service keepalived restart</code></li> <li>如果第一台机重新接管了，则表示成功</li></ul></li></ul></li> <li>可以优化的地方，改为双主热备，监控脚本上带有自启动相关细节，后续再进行。</li> <li>日志中常用的几句话解释：
<ul><li><code>Entering to MASTER STATE</code>，变成 Master 状态
<ul><li><code>Netlink reflector reports IP 192.168.1.50 added</code>，一般变为 Master 状态，都要重新加入虚拟 IP，一般叫法叫做：虚拟 IP 重新漂移到 Master 机子上</li></ul></li> <li><code>Entering BACKUP STATE</code>，变成 Backup 状态
<ul><li><code>Netlink reflector reports IP 192.168.1.50 removed</code>，一般变为 Backup 状态，都要移出虚拟 IP，一般叫法叫做：虚拟 IP 重新漂移到 Master 机子上</li></ul></li> <li><code>VRRP_Script(check_nginx) succeeded</code>，监控脚本执行成功</li></ul></li></ul> <h2 id="资料"><a href="#资料" class="header-anchor">#</a> 资料</h2> <ul><li><a href="http://xutaibao.blog.51cto.com/7482722/1669123" target="_blank" rel="noopener noreferrer">http://xutaibao.blog.51cto.com/7482722/1669123<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://m.oschina.net/blog/301710" target="_blank" rel="noopener noreferrer">https://m.oschina.net/blog/301710<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://blog.csdn.net/u010028869/article/details/50612571" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/u010028869/article/details/50612571<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://blog.csdn.net/wanglei_storage/article/details/51175418" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/wanglei_storage/article/details/51175418<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/adminlove520/Linux_All_in_one/edit/main/docs/linux/soft/Nginx&amp;Tomcat/Nginx-Keepalived-Install-And-Settings.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">3 hours ago</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/Linux_All_in_one/assets/js/app.4a61619a.js" defer></script><script src="/Linux_All_in_one/assets/js/2.ee3c5eb7.js" defer></script><script src="/Linux_All_in_one/assets/js/1.bc260717.js" defer></script><script src="/Linux_All_in_one/assets/js/87.7d10879f.js" defer></script><script src="/Linux_All_in_one/assets/js/21.f8578145.js" defer></script>
  </body>
</html>
